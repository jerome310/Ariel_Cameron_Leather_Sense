<link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script>

<style>
    /* -------------------------
       Swiper Navigation Buttons
       ------------------------- */
    .swiper-button-prev,
    .swiper-button-next {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: black;
        width: 40px;
        height: 40px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        transition: all 0.3s ease;
    }

    .swiper-button-prev:hover,
    .swiper-button-next:hover {
        opacity: 1;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .swiper-button-prev::after,
    .swiper-button-next::after {
        font-size: 24px;
    }

    .swiper-button-prev {
        left: 5px;
    }

    .swiper-button-next {
        right: 5px;
    }

    .swiper-pagination {
        color: black;
        bottom: 0 !important;
    }

    .swiper-pagination-bullet-active {
        background: black !important;
    }

    /* -------------------------
       Number input / quantity
       ------------------------- */
    input[type="number"] {
        outline: none;
        -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .quantity-container {
        display: inline-flex;
        align-items: center;
        margin-top: 1rem;
        border: 2px solid black;
        border-radius: 6px;
        overflow: hidden;
    }

    .quantity-container input {
        text-align: center;
        font-size: 16px;
        padding: 10px 0;
        width: 60px;
        border: none;
        background-color: transparent;
    }

    .quantity-container button {
        font-size: 22px;
        color: #333;
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px 15px;
    }

    .quantity-container .decrement {
        border-right: 2px solid black;
    }

    .quantity-container .increment {
        border-left: 2px solid black;
    }

    /* -------------------------
       Thumbnails
       ------------------------- */
    .thumbnail-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        max-width: 500px;
    }

    .thumbnail-grid img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        cursor: pointer;
        border-radius: 6px;
        border: 1px solid #ddd;
    }

    /* -------------------------
       Mobile box styling
       ------------------------- */
    @media (max-width: 768px) {
        .swiper-slide {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 0 10px;
        }

        .swiper-slide .product-images {
            background-color: rgba(246, 246, 246, 0.75);
            border-radius: 1rem;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .swiper-slide .product-images img {
            width: 100%;
            height: auto;
            border-radius: 1rem;
            object-fit: contain;
            background-color: #f6f6f6;
        }

        .swiper {
            padding-bottom: 20px;
        }
    }

    /* -------------------------
       Modal (Lightbox) Styles
       ------------------------- */
    .image-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        /* toggled by JS */
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
        backdrop-filter: blur(2px);
        transition: opacity 220ms ease;
    }

    .image-modal-overlay.open {
        display: flex;
        opacity: 1;
    }

    .image-modal {
        max-width: 94vw;
        max-height: 92vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        animation: modalPop 220ms ease;
    }

    @keyframes modalPop {
        from {
            transform: scale(0.98);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .image-modal-content {
        max-width: 100%;
        max-height: 100%;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
        overflow: hidden;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .image-modal-content img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        background: #f6f6f6;
    }

    /* Modal arrows */
    .modal-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background 160ms ease, transform 160ms ease;
    }

    .modal-arrow:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-50%) scale(1.03);
    }

    .modal-arrow svg {
        width: 20px;
        height: 20px;
        color: #111;
    }

    .modal-arrow.prev {
        left: 12px;
    }

    .modal-arrow.next {
        right: 12px;
    }

    /* Close button */
    .modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 15;
        transition: background 160ms ease;
    }

    .modal-close svg {
        width: 18px;
        height: 18px;
        color: #fff;
    }

    .modal-close:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    /* On small viewports make arrows slightly smaller */
    @media (max-width: 480px) {
        .modal-arrow {
            width: 40px;
            height: 40px;
        }

        .modal-arrow svg {
            width: 16px;
            height: 16px;
        }
    }
</style>

<div class="max-w-6xl mx-auto my-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-20">
        <div class="product--medias">
            <!-- Desktop Images -->
            <div class="hidden md:block">
                <div class="h-100 overflow-hidden p-2">
                    <div class="product-images">
                        <!-- MAIN IMAGE -->
                        <img id="main-product-image"
                            class="w-full h-[400px] md:h-full object-cover bg-gray-100 rounded-2xl"
                            src="{{ product.featured_image | img_url: 'large' }}" alt="{{ product.title }}"
                            style="cursor: zoom-in;">

                        <!-- THUMBNAILS -->
                        <div class="thumbnail-grid">
                            {% for image in product.images %}
                            <img class="thumbnail-image" src="{{ image.src | img_url: 'large' }}"
                                alt="{{ product.title }}">
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Swiper -->
            <div class="md:hidden">
                <div class="swiper">
                    <div class="swiper-wrapper">
                        {% for image in product.images %}
                        <div class="swiper-slide">
                            <div class="product-images">
                                <img class="swiper-slide-image w-full object-cover rounded-2xl"
                                    src="{{ image.src | img_url: 'large' }}" alt="{{ product.title }}">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                </div>
            </div>
        </div>

        <div class="product--information pl-4 md:pl-0">
            <h2 class="text-sm pt-8 md:pt-0">{{ product.vendor }}</h2>
            <h3 class="text-5xl font-bold pt-2">{{ product.title }}</h3>
            <p class="text-[17px] py-4">{{ product.price | money }} USD</p>

            <div class="shopify-installments" style="padding-bottom: 1rem;">
                {% form 'product', product %}
                {{ form | payment_terms }}
                {% endform %}
            </div>

            <form action="/cart/add" method="post">
                <input type="hidden" name="id" value="{{ product.variants.first.id }}">

                <div class="quantity-container">
                    <button type="button" class="decrement" onclick="decrementQuantity()">-</button>
                    <input type="number" id="quantity" name="quantity" value="1" min="1">
                    <button type="button" class="increment" onclick="incrementQuantity()">+</button>
                </div>

                {% render 'add-to-cart-button' %}
            </form>

            <div class="description-par mt-6">
                <p class="text-left pr-28">{{ product.description }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Markup -->
<div id="imageModalOverlay" class="image-modal-overlay" aria-hidden="true">
    <div class="image-modal" role="dialog" aria-modal="true" aria-label="Product image gallery">
        <div class="image-modal-content" id="imageModalContent">
            <button class="modal-arrow prev" id="modalPrev" aria-label="Previous image">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>

            <img id="modalImage" src="" alt="Expanded product image">

            <button class="modal-arrow next" id="modalNext" aria-label="Next image">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>

            <button class="modal-close" id="modalClose" aria-label="Close image viewer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    /* -------------------------
       Quantity helpers
       ------------------------- */
    function incrementQuantity() {
        var quantityInput = document.getElementById('quantity');
        quantityInput.value = parseInt(quantityInput.value, 10) + 1;
    }

    function decrementQuantity() {
        var quantityInput = document.getElementById('quantity');
        if (parseInt(quantityInput.value, 10) > 1) {
            quantityInput.value = parseInt(quantityInput.value, 10) - 1;
        }
    }

    /* -------------------------
       Gallery setup
       ------------------------- */
    var galleryImages = [
        {% for image in product.images %}
    "{{ image.src | img_url: 'large' }}"{% unless forloop.last %}, {% endunless %}
    {% endfor %}
    ];

    var currentMainImageIndex = 0; // Track which image is currently on main

    function switchImage(index) {
        var main = document.getElementById('main-product-image');
        main.src = galleryImages[index];
        currentMainImageIndex = index;
    }

    /* -------------------------
       Modal helpers
       ------------------------- */
    var overlay = document.getElementById('imageModalOverlay');
    var modalImage = document.getElementById('modalImage');
    var modalPrev = document.getElementById('modalPrev');
    var modalNext = document.getElementById('modalNext');
    var modalClose = document.getElementById('modalClose');
    var currentModalIndex = 0;

    function openModal(index) {
        currentModalIndex = (typeof index === 'number') ? index : currentMainImageIndex;
        showModalImage(currentModalIndex);
        overlay.classList.add('open');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    function showModalImage(index) {
        currentModalIndex = (index + galleryImages.length) % galleryImages.length;
        modalImage.src = galleryImages[currentModalIndex];
        modalImage.alt = "{{ product.title }} â€” image " + (currentModalIndex + 1);
    }

    function showPrev() { showModalImage(currentModalIndex - 1); }
    function showNext() { showModalImage(currentModalIndex + 1); }

    overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closeModal();
    });

    modalClose.addEventListener('click', closeModal);
    modalPrev.addEventListener('click', e => { e.stopPropagation(); showPrev(); });
    modalNext.addEventListener('click', e => { e.stopPropagation(); showNext(); });

    document.addEventListener('keydown', function (e) {
        if (overlay.classList.contains('open')) {
            if (e.key === 'Escape' || e.key === 'Esc') closeModal();
            if (e.key === 'ArrowLeft') showPrev();
            if (e.key === 'ArrowRight') showNext();
        }
    });

    /* -------------------------
       Wire up click handlers
       ------------------------- */
    var mainImageEl = document.getElementById('main-product-image');
    if (mainImageEl) {
        mainImageEl.addEventListener('click', function () {
            openModal(currentMainImageIndex);
        });
    }

    var thumbnails = document.querySelectorAll('.thumbnail-grid img.thumbnail-image');
    thumbnails.forEach(function (thumb, index) {
        thumb.addEventListener('click', function () {
            switchImage(index); // update main image
        });
    });

    var swiperSlideImages = document.querySelectorAll('.swiper-slide-image');
    swiperSlideImages.forEach(function (img, index) {
        img.addEventListener('click', function () {
            openModal(index);
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        new Swiper('.swiper', {
            loop: true,
            pagination: { el: '.swiper-pagination', clickable: true },
            navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
        });
    });
</script>